# mamafern – Next Session Implementation Plan

## Current State Summary

The storefront is a Next.js 15 + Shopify Storefront API app with:
- Product browsing (collections, product detail pages)
- Cart state management (Jotai atom, Shopify-synced)
- Auth pages (login + signup, Shopify customer tokens)
- Basic navbar with cart icon + login button

---

## Gaps Found vs. a Production-Ready Storefront

### Critical (blocks core user journeys)

| # | Gap | Detail |
|---|-----|--------|
| 1 | **No cart UI** | The cart icon skips directly to `checkoutUrl`. Users can't review items, change quantities, or apply discounts before paying. |
| 2 | **No checkout flow** | `checkoutUrl` is generated but never enhanced with a logged-in customer token, so Shopify checkout won't know who the customer is. |
| 3 | **No discount/coupon code UI** | Shopify supports `cartDiscountCodesUpdate` but it is not implemented. |
| 4 | **Newsletter opt-in missing** | `acceptsMarketing` field is never passed in `customerCreate`. No standalone subscribe form exists. |
| 5 | **Auth state not reflected in navbar** | Navbar always shows "Login" even when a customer is authenticated. No logout. |
| 6 | **Metadata is placeholder** | `title: "Create Next App"` and `description: "Generated by create next app"` ship as-is. |
| 7 | **Logo is not branded** | Logo component says "Minimal Store" – not "mamafern". |

### Important (expected by shoppers)

| # | Gap | Detail |
|---|-----|--------|
| 8 | **No account/profile page** | GraphQL for `GET_CUSTOMER`, `CUSTOMER_UPDATE`, `GET_CUSTOMER_ORDERS` exists but no page. |
| 9 | **No order history UI** | Order data is queryable but not displayed anywhere. |
| 10 | **No footer** | No footer component – no newsletter signup, no policy links, no social links. |
| 11 | **Navbar links are hardcoded** | "Men" and "Women" collection slugs are hard-coded; should reflect actual Shopify collections. |
| 12 | **No search** | No product search. |
| 13 | **No empty cart / empty collection state** | No empty state messaging. |
| 14 | **No 404 page** | Missing `not-found.tsx` for invalid product/collection handles. |

### Nice to Have

| # | Gap |
|---|-----|
| 15 | Social sharing on product pages |
| 16 | Recently viewed products |
| 17 | Product recommendations (Shopify API supports this) |
| 18 | Blog / content pages |
| 19 | About & Contact pages |

---

## Tomorrow's Implementation Plan (Priority Order)

---

### PHASE 1 – Branding & Metadata (15 min)

**Files to edit:**
- `src/app/layout.tsx` – update `metadata` title/description
- `src/components/view/Logo/index.tsx` – change "Minimal Store" to "mamafern"
- `tailwind.config.ts` / `globals.css` – add brand color tokens (earthy/botanical palette to match name)

---

### PHASE 2 – Cart Drawer + Checkout (largest piece)

**Goal:** Replace the direct-to-checkout cart icon with a slide-out cart drawer.

**New files:**
- `src/components/view/CartDrawer/index.tsx`
  - Lists cart line items (image, title, variant, price, quantity controls)
  - Remove item button per line
  - Subtotal + "Proceed to Checkout" CTA
  - Discount code input field (see Phase 3)
  - Empty state message when cart is empty

**New shadcn/ui components to install:**
- `Sheet` (slide-out drawer) – `npx shadcn@latest add sheet`
- `Separator` – `npx shadcn@latest add separator`
- `ScrollArea` – `npx shadcn@latest add scroll-area`

**Files to edit:**
- `src/components/view/Navbar/index.tsx`
  - Replace `router.push(checkoutUrl)` on cart icon with `setCartOpen(true)`
  - Import and render `<CartDrawer />`

**Checkout authentication wiring:**
- When user is logged in (`customerAccessToken` cookie exists), use the
  `cartBuyerIdentityUpdate` mutation to associate the token with the cart before
  redirecting to `checkoutUrl`. This pre-fills the checkout with their address.
- New GraphQL mutation in `src/graphql/cart.ts`:
  ```graphql
  mutation cartBuyerIdentityUpdate($cartId: ID!, $buyerIdentity: CartBuyerIdentityInput!) {
    cartBuyerIdentityUpdate(cartId: $cartId, buyerIdentity: $buyerIdentity) {
      cart { id checkoutUrl }
    }
  }
  ```

---

### PHASE 3 – Discount / Coupon Codes

**New GraphQL mutation** in `src/graphql/cart.ts`:
```graphql
mutation cartDiscountCodesUpdate($cartId: ID!, $discountCodes: [String!]!) {
  cartDiscountCodesUpdate(cartId: $cartId, discountCodes: $discountCodes) {
    cart {
      id
      discountCodes { code applicable }
      cost { totalAmount { amount currencyCode } }
    }
    userErrors { field message }
  }
}
```

**Cart state update** in `src/lib/atoms/cart.tsx`:
- Add `discountCodes` field to `CartState`
- Add `applyDiscount(code: string)` action
- Show "invalid code" error toast if `applicable: false`

**UI:** Add a collapsible "Have a promo code?" input inside `CartDrawer`.

---

### PHASE 4 – Auth: Newsletter / Email Marketing

**Goal:** Let users opt into marketing at signup AND let non-account visitors subscribe
with just their email.

#### 4a – `acceptsMarketing` on account creation

**File:** `src/components/view/Auth/Signup/index.tsx`
- Add `acceptsMarketing: z.boolean().default(true)` to `signupSchema`
- Add a `<Checkbox>` field: "Subscribe to emails for deals & new arrivals"
- Pass `acceptsMarketing: values.acceptsMarketing` in the `customerCreate` mutation variables

**File:** `src/graphql/auth.ts`
- `CUSTOMER_CREATE` mutation already accepts `CustomerCreateInput` – `acceptsMarketing`
  is a valid field, just add it to the `input` variable block.

#### 4b – Standalone newsletter signup widget

**New file:** `src/components/view/NewsletterSignup/index.tsx`
- Email-only form (no password)
- On submit: calls `customerCreate` with `acceptsMarketing: true` and a placeholder
  password (Shopify requires one). Display success/error toast.
- **Alternative approach** (recommended if you have a marketing platform): use a
  Klaviyo or Mailchimp embed form. Add an env var `NEXT_PUBLIC_KLAVIYO_LIST_ID` /
  `NEXT_PUBLIC_MC_URL`. The component conditionally renders the external embed or
  falls back to the Shopify mutation.

**This component is used in:**
- Footer (see Phase 5)
- Optionally: a homepage banner section

#### 4c – Auth state in Navbar

**File:** `src/components/view/Navbar/index.tsx`
- Read `customerAccessToken` cookie with `parseCookies()` (already used in auth page)
- If token present: show "My Account" link + "Logout" button; hide "Login"
- Logout clears the cookie and resets cart state

---

### PHASE 5 – Account / Profile Page

**New page:** `src/app/account/page.tsx`
- Protected: redirects to `/auth` if no token
- Sections:
  1. **Profile** – display name, email; edit button (calls `customerUpdate`)
  2. **Order History** – list from `GET_CUSTOMER_ORDERS`, paginated
  3. **Email preferences** – toggle `acceptsMarketing` via `customerUpdate`

**Files to edit:**
- `src/graphql/profile.ts` – already has all needed queries; just needs a
  `CUSTOMER_UPDATE` mutation wired to marketing preference toggle

---

### PHASE 6 – Footer with Newsletter

**New file:** `src/components/view/Footer/index.tsx`
- Three columns:
  1. Logo + short tagline
  2. Quick links (Shop, About, Contact, FAQ)
  3. Newsletter signup form (`<NewsletterSignup />`)
- Bottom bar: © mamafern | Privacy | Terms | Shipping & Returns

**File:** `src/app/layout.tsx`
- Import and render `<Footer />` below `{children}`

---

### PHASE 7 – Static Pages

**New pages (minimal content stubs, easy to fill):**
- `src/app/about/page.tsx`
- `src/app/contact/page.tsx`
- `src/app/faq/page.tsx`

---

### PHASE 8 – 404 + Error States

- `src/app/not-found.tsx` – branded 404 page
- `src/app/error.tsx` – error boundary page
- Empty state components inside `AllCollections` and `CartDrawer`

---

## Environment Variables Needed

Make sure `.env.local` has these set before next session:

```
NEXT_PUBLIC_SHOPIFY_STORE_API_URL=https://<your-store>.myshopify.com/api/2024-01/graphql.json
NEXT_PUBLIC_SHOPIFY_STOREFRONT_ACCESS_TOKEN=<your-storefront-token>

# Optional – for external email marketing
NEXT_PUBLIC_KLAVIYO_LIST_ID=<list-id>         # if using Klaviyo
NEXT_PUBLIC_MC_SUBSCRIBE_URL=<mailchimp-url>   # if using Mailchimp
```

---

## Dependency Installs Needed at Start of Next Session

```bash
npx shadcn@latest add sheet separator scroll-area
```

---

## Suggested Build Order for Next Session

```
1. Branding (Logo, metadata)
2. shadcn Sheet/Separator/ScrollArea install
3. CartDrawer component
4. Navbar wired to CartDrawer
5. cartDiscountCodesUpdate mutation + CartDrawer UI
6. cartBuyerIdentityUpdate (auth → checkout link)
7. acceptsMarketing checkbox on Signup form
8. Navbar auth state + logout
9. NewsletterSignup component
10. Footer with NewsletterSignup
11. Account/Profile page
12. Static pages (About, Contact, FAQ stubs)
13. 404 + Error pages
14. Metadata SEO pass
```

---

## Notes on "Shop Plugin for Checkout"

The Shopify Buy Button / Buy SDK ("shop plugin") is a separate embed.
The current setup does **not** use it — it uses the Storefront API directly,
which is the more modern and flexible approach. The key missing piece is simply
the **cart drawer UI + checkout redirect button**. Once Phase 2 is done,
clicking "Proceed to Checkout" will redirect users to the native Shopify
checkout (hosted by Shopify), which handles payment, shipping, taxes, and
order confirmation automatically. No additional plugin is needed.

If you do want the Shopify Buy Button embed widget (e.g. for embedding on
a separate site), install `@shopify/buy-button-js` and configure it with
your store domain and storefrontAccessToken.
